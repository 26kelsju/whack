<!DOCTYPE html>
<html>
<head>
    <title>Whack-A-Mole VR (Revised)</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>
<body>
    <a-scene>
        <a-assets>
            <a-mixin id="mole-mixin"
                     animation__up="property: position; to: 0 0.4 0; dur: 300; easing: easeOutQuad; startEvents: pop"
                     animation__down="property: position; to: 0 -0.8 0; dur: 200; easing: easeInQuad; startEvents: hide">
            </a-mixin>
        </a-assets>

        <a-plane id="ground" position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
        <a-sky color="#87CEEB"></a-sky>

        <a-entity id="mole-holes">
            <a-cylinder class="hole" position="-1.5 0.1 -3" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="0 0.1 -3" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="1.5 0.1 -3" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="-1.5 0.1 -4.5" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="0 0.1 -4.5" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="1.5 0.1 -4.5" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
        </a-entity>

        <a-text id="score-text" value="Score: 0" position="-1.5 2.5 -3" color="black" width="5"></a-text>
        <a-text id="timer-text" value="Time: 30" position="1.5 2.5 -3" color="black" width="5" align="right"></a-text>

        <a-camera>
            <a-cursor color="yellow" raycaster="objects: .mole-entity"></a-cursor>
        </a-camera>

        <script>
            AFRAME.registerComponent('game-logic', {
                schema: {
                    gameDuration: {type: 'number', default: 30000} // 30 seconds
                },

                init: function () {
                    this.holes = document.querySelectorAll('.hole');
                    this.score = 0;
                    this.scoreText = document.querySelector('#score-text');
                    this.timerText = document.querySelector('#timer-text');
                    this.moles = new Set(); // Use a Set for easier management
                    this.timeLeft = this.data.gameDuration / 1000;
                    this.gameTimer = null;
                    this.moleTimer = null;
                    
                    this.startGame();
                },
                
                startGame: function() {
                    this.score = 0;
                    this.updateScore(0);
                    this.timeLeft = this.data.gameDuration / 1000;
                    this.timerText.setAttribute('value', 'Time: ' + this.timeLeft);

                    // Start game countdown timer
                    this.gameTimer = setInterval(() => {
                        this.timeLeft--;
                        this.timerText.setAttribute('value', 'Time: ' + this.timeLeft);
                        if (this.timeLeft <= 0) {
                            this.endGame();
                        }
                    }, 1000);

                    // Start spawning moles
                    this.moleTimer = setInterval(this.spawnMole.bind(this), 1000);
                },

                endGame: function() {
                    clearInterval(this.gameTimer);
                    clearInterval(this.moleTimer);
                    this.timerText.setAttribute('value', 'Game Over!');
                    this.moles.forEach(mole => mole.parentNode.removeChild(mole));
                    this.moles.clear();
                },

                spawnMole: function () {
                    const availableHoles = Array.from(this.holes).filter(hole => !hole.hasChildNodes());
                    if (availableHoles.length === 0) return;

                    const randomHole = availableHoles[Math.floor(Math.random() * availableHoles.length)];
                    
                    const mole = document.createElement('a-entity');
                    mole.classList.add('mole-entity');
                    
                    // Use the mixin for animations
                    mole.setAttribute('mixin', 'mole-mixin');
                    mole.setAttribute('position', {x: 0, y: -0.8, z: 0}); // Start below the ground
                    mole.setAttribute('material', 'color', '#654321');

                    // Randomly choose geometry
                    if (Math.random() > 0.5) {
                        mole.setAttribute('geometry', 'primitive: box; width: 0.5; height: 0.8; depth: 0.5');
                    } else {
                        mole.setAttribute('geometry', 'primitive: sphere; radius: 0.3');
                    }
                    
                    randomHole.appendChild(mole);
                    this.moles.add(mole);
                    
                    mole.emit('pop');

                    mole.addEventListener('click', () => this.moleWhacked(mole), {once: true});

                    setTimeout(() => {
                        if (this.moles.has(mole)) {
                           mole.emit('hide');
                           setTimeout(() => {
                               if (mole.parentNode) {
                                   mole.parentNode.removeChild(mole);
                                   this.moles.delete(mole);
                               }
                           }, 300); // Wait for hide animation to finish
                        }
                    }, 1800 + Math.random() * 500); // Stays up for 1.8 - 2.3 seconds
                },

                moleWhacked: function(mole) {
                    if (!this.moles.has(mole)) return;

                    this.updateScore(1);
                    mole.parentNode.removeChild(mole);
                    this.moles.delete(mole);
                },

                updateScore: function(points) {
                    this.score += points;
                    this.scoreText.setAttribute('value', 'Score: ' + this.score);
                }
            });
        </script>

        <a-entity game-logic></a-entity>
    </a-scene>
</body>
</html>
