<!DOCTYPE html>
<html>
<head>
    <title>Whack-A-Mole VR</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>
<body>
    <a-scene>
        <a-assets>
            <a-mixin id="mole" geometry="primitive: box; height: 0.8" material="color: #654321"
                     animation__up="property: position; to: 0 0.4 0; dur: 300; easing: easeOutQuad; startEvents: pop"
                     animation__down="property: position; to: 0 -0.8 0; dur: 200; easing: easeInQuad; startEvents: hide">
            </a-mixin>
        </a-assets>

        <a-plane id="ground" position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
        <a-sky color="#87CEEB"></a-sky>

        <a-entity id="mole-holes">
            <a-cylinder class="hole" position="-1.5 0.1 -3" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="0 0.1 -3" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="1.5 0.1 -3" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="-1.5 0.1 -4.5" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="0 0.1 -4.5" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
            <a-cylinder class="hole" position="1.5 0.1 -4.5" radius="0.4" height="0.1" color="#4a2a0a"></a-cylinder>
        </a-entity>

        <a-text id="score-text" value="Score: 0" position="-1.5 2.5 -3" color="black" width="5"></a-text>
        <a-text id="timer-text" value="Time: 30" position="1.5 2.5 -3" color="black" width="5" align="right"></a-text>

        <a-camera>
            <a-cursor color="yellow" raycaster="objects: .mole-entity"></a-cursor>
        </a-camera>

        <script>
            AFRAME.registerComponent('game-logic', {
                schema: {
                    gameDuration: {type: 'number', default: 30000} // 30 seconds
                },

                init: function () {
                    this.holes = document.querySelectorAll('.hole');
                    this.score = 0;
                    this.scoreText = document.querySelector('#score-text');
                    this.timerText = document.querySelector('#timer-text');
                    this.moles = [];
                    this.timeLeft = this.data.gameDuration / 1000;
                    this.gameTimer = null;
                    this.moleTimer = null;
                    
                    this.startGame();
                },
                
                startGame: function() {
                    this.score = 0;
                    this.updateScore(0);
                    this.timeLeft = this.data.gameDuration / 1000;

                    // Start game countdown timer
                    this.gameTimer = setInterval(() => {
                        this.timeLeft--;
                        this.timerText.setAttribute('value', 'Time: ' + this.timeLeft);
                        if (this.timeLeft <= 0) {
                            this.endGame();
                        }
                    }, 1000);

                    // Start spawning moles
                    this.moleTimer = setInterval(this.spawnMole.bind(this), 1000); // Spawn a mole every second
                },

                endGame: function() {
                    clearInterval(this.gameTimer);
                    clearInterval(this.moleTimer);
                    this.timerText.setAttribute('value', 'Game Over!');
                    // Remove any remaining moles
                    this.moles.forEach(mole => mole.parentNode.removeChild(mole));
                    this.moles = [];
                },

                spawnMole: function () {
                    // Choose a random hole that doesn't already have a mole
                    const availableHoles = Array.from(this.holes).filter(hole => !hole.querySelector('.mole-entity'));
                    if (availableHoles.length === 0) return;

                    const randomHole = availableHoles[Math.floor(Math.random() * availableHoles.length)];
                    
                    // Create a new mole
                    const mole = document.createElement('a-entity');
                    mole.classList.add('mole-entity');
                    mole.setAttribute('position', {x: 0, y: -0.8, z: 0}); // Start below the ground

                    // Randomly choose between a box and a sphere
                    if (Math.random() > 0.5) {
                        mole.setAttribute('geometry', 'primitive: box; width: 0.5; height: 0.8; depth: 0.5');
                    } else {
                        mole.setAttribute('geometry', 'primitive: sphere; radius: 0.3');
                        mole.setAttribute('position', {x: 0, y: -0.5, z: 0});
                    }
                    mole.setAttribute('material', 'color', '#654321');

                    // Add animations
                    mole.setAttribute('animation__up', 'property: position.y; to: 0.4; dur: 300; easing: easeOutQuad; startEvents: pop');
                    mole.setAttribute('animation__down', 'property: position.y; to: -0.8; dur: 200; easing: easeInQuad; startEvents: hide');
                    
                    // Add mole to the scene inside the hole
                    randomHole.appendChild(mole);
                    this.moles.push(mole);
                    
                    // Trigger the 'pop' up animation
                    mole.emit('pop');

                    // Listen for clicks (or gazes)
                    mole.addEventListener('click', this.moleWhacked.bind(this, mole));

                    // Make the mole hide after a short time
                    setTimeout(() => {
                        if (mole.parentNode) { // Check if it hasn't been whacked already
                           mole.emit('hide');
                           // After hiding, remove the mole from the scene
                           setTimeout(() => {
                               if (mole.parentNode) {
                                   mole.parentNode.removeChild(mole);
                                   this.moles.splice(this.moles.indexOf(mole), 1);
                               }
                           }, 300);
                        }
                    }, 1500 + Math.random() * 500); // Stays up for 1.5 - 2.0 seconds
                },

                moleWhacked: function(mole) {
                    if (!mole.parentNode) return; // Already whacked

                    this.updateScore(1);
                    mole.parentNode.removeChild(mole);
                    this.moles.splice(this.moles.indexOf(mole), 1);
                },

                updateScore: function(points) {
                    this.score += points;
                    this.scoreText.setAttribute('value', 'Score: ' + this.score);
                }
            });
        </script>

        <a-entity game-logic></a-entity>
    </a-scene>
</body>
</html>
